<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ctrl-F Chat Viewer</title>
  <!-- Bootstrap CSS -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
    rel="stylesheet"
  />
  <link rel="stylesheet" href="chat-view.css" />
  <style>
    .pdf-page { position: relative; margin: 1em 0; }
    .highlightLayer div { pointer-events: none; }
    .pdf-container { position: relative; overflow: auto; }
    /* Optional sidebar styling */
    #hitSidebar .list-group-item { cursor: pointer; }
    #hitSidebar .list-group-item:hover { background-color: rgba(0,0,0,0.05); }
  </style>
  <!-- PDF.js UMD build (only once!) -->
  <script src="https://unpkg.com/pdfjs-dist@2.18.191/build/pdf.min.js"></script>
  <script>
    // Configure the PDF.js worker
    pdfjsLib.GlobalWorkerOptions.workerSrc =
      'https://unpkg.com/pdfjs-dist@2.18.191/build/pdf.worker.min.js';
  </script>
</head>
<body class="d-flex flex-column" style="height:100vh; margin:0">
  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg nav-blur border-bottom border-secondary shadow-sm py-2 sticky-top">
    <div class="container-fluid d-flex justify-content-between align-items-center">
      <div class="d-flex" style="width: 33%;"></div>
      <div class="d-flex justify-content-center" style="width: 33%;">
        <a class="navbar-brand" href="/src/landing-page/landing-page.html">
          <img src="/src/assets/logo.png" alt="Ctrl-F Logo" height="70">
        </a>
      </div>
      <div class="d-flex justify-content-end align-items-center" style="width: 33%;">
        <ul class="navbar-nav flex-row">
          <li class="nav-item">
            <a class="nav-link nav-lg-link text-light mx-3" href="../about-page/about-page.html">About</a>
          </li>
          <li class="nav-item">
            <a class="nav-link nav-lg-link text-light mx-3" href="https://github.com/Nikolay-Ts/Ctrl-f" target="_blank">Source Code</a>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <!-- Main Content -->
  <div class="container-fluid flex-grow-1 d-flex flex-column p-0">
    <div class="row g-0 flex-grow-1">
      <!-- Chat Column -->
      <div class="col-md-8 p-3" style="min-height:0">
        <div class="d-flex flex-row h-100">
          <!-- Sidebar for PDF pages -->
          <div id="hitSidebar"
               class="ultra-card p-3 me-3 list-group"
               style="width: 250px; overflow-y: auto;">
            <!-- JS will inject the page list here -->
          </div>
          <!-- Chat Area -->
          <div class="d-flex flex-column flex-grow-1">
            <div class="ultra-card p-3 flex-grow-1 chat-container" id="chatContainer"></div>
            <div class="chat-input-bar">
              <textarea id="chatInput" rows="1" placeholder="Type your message…"></textarea>
              <button id="sendBtn" aria-label="Send">&#10148;</button>
            </div>
          </div>
        </div>
      </div>

      <!-- PDF Viewer Column -->
      <div class="col-md-4 p-3">
        <div class="ultra-card p-3 shadow-lg pdf-container" id="pdfContainer"></div>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <!-- PDF Rendering & Chat Logic -->
  <script>
  (async function() {
    // Ensure PDF.js is available
    if (!window.pdfjsLib) {
      console.error('PDF.js not loaded—check the <script> above.');
      return;
    }
    const pdfjs = window.pdfjsLib;

    //
    // 1) Determine PDF URL & name from sessionStorage (fallback to test file)
    //
    const url     = sessionStorage.getItem('pdfUrl')  || '../test-data/RIS-lab.pdf';
    const pdfName = sessionStorage.getItem('pdfName') || url.split('/').pop();
    sessionStorage.setItem('pdfUrl', url);
    sessionStorage.setItem('pdfName', pdfName);

    //
    // 2) Load the PDF document
    //
    const pdf = await pdfjs.getDocument(url).promise;
    window._loadedPdf = pdf;

    //
    // 3) Render all pages
    //
    const viewer = document.getElementById('pdfContainer');
    viewer.innerHTML = '';  // clear old pages
    for (let i = 1; i <= pdf.numPages; i++) {
      const page = await pdf.getPage(i);
      const vp   = page.getViewport({ scale: 1 });

      const pageDiv = document.createElement('div');
      pageDiv.id = `pageContainer${i}`;
      pageDiv.className = 'pdf-page';
      Object.assign(pageDiv.style, {
        position: 'relative',
        width:  `${vp.width}px`,
        height: `${vp.height}px`
      });

      // Canvas for rendering
      const canvas = document.createElement('canvas');
      canvas.width  = vp.width;
      canvas.height = vp.height;
      pageDiv.appendChild(canvas);
      await page.render({
        canvasContext: canvas.getContext('2d'),
        viewport:      vp
      }).promise;

      // Text layer (for future highlighting)
      const textLayer = document.createElement('div');
      textLayer.className = 'textLayer';
      Object.assign(textLayer.style, {
        position: 'absolute', top: 0, left: 0,
        width: `${vp.width}px`,
        height:`${vp.height}px`
      });
      page.getTextContent().then(tc =>
        pdfjs.renderTextLayer({
          textContent: tc,
          container:   textLayer,
          viewport:    vp,
          textDivs:    []
        })
      );
      pageDiv.appendChild(textLayer);

      viewer.appendChild(pageDiv);
    }

    //
    // 4) Populate the left sidebar with one entry per page
    //
    const sidebar = document.getElementById('hitSidebar');
    sidebar.innerHTML = '';  // clear any previous items
    for (let i = 1; i <= pdf.numPages; i++) {
      const item = document.createElement('div');
      item.className = 'pdf-item list-group-item list-group-item-action';
      item.textContent = `${pdfName} – Page ${i}`;
      item.dataset.page = i;
      sidebar.appendChild(item);
    }

    //
    // 5) Click handler: smooth-scroll to that page
    //
    sidebar.addEventListener('click', e => {
      const tgt = e.target.closest('.pdf-item');
      if (!tgt) return;
      const pg = Number(tgt.dataset.page);
      const pd = document.getElementById(`pageContainer${pg}`);
      if (pd) pd.scrollIntoView({ behavior: 'smooth' });
    });

    //
    // 6) Existing chat logic
    //
    (function () {
      const chatContainer = document.getElementById('chatContainer');
      const inputEl       = document.getElementById('chatInput');
      const sendBtn       = document.getElementById('sendBtn');
      let msgs = JSON.parse(sessionStorage.getItem('ctrlf_chat') || '[]');

      function renderChat() {
        chatContainer.innerHTML = '';
        msgs.forEach(m => {
          const b = document.createElement('div');
          b.className = 'chat-bubble user';
          b.textContent = m;
          chatContainer.appendChild(b);
        });
        chatContainer.scrollTop = chatContainer.scrollHeight;
      }

      function addMessage(text) {
        msgs.push(text);
        sessionStorage.setItem('ctrlf_chat', JSON.stringify(msgs));
        renderChat();
      }

      renderChat();
      sendBtn.addEventListener('click', () => {
        const txt = inputEl.value.trim();
        if (!txt) return;
        addMessage(txt);
        inputEl.value = '';
        inputEl.focus();
      });
      inputEl.addEventListener('keydown', e => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          sendBtn.click();
        }
      });
    })();

    //
    // 7) (Optional) Expose highlight API
    //
    async function getMatches(containerId, matches) {
      if (!Array.isArray(matches) || !matches.length) return;
      for (let { page, text } of matches) {
        const pageObj = await pdf.getPage(page);
        const vp      = pageObj.getViewport({ scale: 1 });
        const { items } = await pageObj.getTextContent();
        const rects = [];

        for (let item of items) {
          let idx = 0;
          while ((idx = item.str.indexOf(text, idx)) !== -1) {
            const [ , , , , e, f ] =
              pdfjs.Util.transform(vp.transform, item.transform);
            const h     = item.height * vp.scale;
            const charW = (item.width * vp.scale) / item.str.length;
            rects.push({
              x: e + charW * idx,
              y: f - h,
              w: charW * text.length,
              h
            });
            idx += text.length;
          }
        }

        const pageDiv = document.getElementById(`pageContainer${page}`);
        let hlLayer = pageDiv.querySelector('.highlightLayer');
        if (!hlLayer) {
          hlLayer = document.createElement('div');
          Object.assign(hlLayer.style, {
            position: 'absolute', top: 0, left: 0,
            width: '100%', height: '100%',
            pointerEvents: 'none'
          });
          hlLayer.className = 'highlightLayer';
          pageDiv.appendChild(hlLayer);
        }

        rects.forEach(r => {
          const hl = document.createElement('div');
          Object.assign(hl.style, {
            position: 'absolute',
            left:   `${r.x}px`,
            top:    `${r.y}px`,
            width:  `${r.w}px`,
            height: `${r.h}px`,
            background: 'rgba(255,255,0,0.4)'
          });
          hlLayer.appendChild(hl);
        });
      }
    }
    window.getMatches = getMatches;

  })();
  </script>
</body>
</html>