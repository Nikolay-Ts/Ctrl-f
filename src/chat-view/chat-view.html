<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ctrl-F Chat Viewer</title>
  <!-- Bootstrap CSS -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
    rel="stylesheet"
  />
  <link rel="stylesheet" href="chat-view.css" />
  <style>
    .pdf-page { position: relative; margin: 1em 0; }
    .highlightLayer div { pointer-events: none; }
    .pdf-container { position: relative; overflow: auto; }
  </style>
</head>
<body class="d-flex flex-column" style="height:100vh; margin:0">
  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg nav-blur border-bottom border-secondary shadow-sm py-2 sticky-top">
    <div class="container-fluid d-flex justify-content-between align-items-center">
      <div class="d-flex" style="width: 33%;"></div>
      <div class="d-flex justify-content-center" style="width: 33%;">
        <a class="navbar-brand" href="/src/landing-page/landing-page.html">
          <img src="/src/assets/logo.png" alt="Ctrl-F Logo" height="70">
        </a>
      </div>
      <div class="d-flex justify-content-end align-items-center" style="width: 33%;">
        <ul class="navbar-nav flex-row">
          <li class="nav-item">
            <a class="nav-link nav-lg-link text-light mx-3" href="../about-page/about-page.html">About</a>
          </li>
          <li class="nav-item">
            <a class="nav-link nav-lg-link text-light mx-3" href="https://github.com/Nikolay-Ts/Ctrl-f" target="_blank">Source Code</a>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <!-- Main Content -->
  <div class="container-fluid flex-grow-1 d-flex flex-column p-0">
    <div class="row g-0 flex-grow-1">
      <!-- Chat Column -->
      <div class="col-md-8 p-3" style="min-height:0">
        <div class="d-flex flex-row h-100">
          <!-- Sidebar for PDF hits -->
          <div id="hitSidebar"
               class="ultra-card p-3 me-3"
               style="width: 250px; overflow-y: auto;">
            <!-- JS will inject a list of matches here -->
          </div>
          <!-- Chat Area -->
          <div class="d-flex flex-column flex-grow-1">
            <div class="ultra-card p-3 flex-grow-1 chat-container" id="chatContainer"></div>
            <div class="chat-input-bar">
              <textarea id="chatInput" rows="1" placeholder="Type your message…"></textarea>
              <button id="sendBtn" aria-label="Send">&#10148;</button>
            </div>
          </div>
        </div>
      </div>

      <!-- PDF Sidebar using PDF.js -->
      <div class="col-md-4 p-3">
        <div class="ultra-card p-3 shadow-lg pdf-container" id="pdfContainer"></div>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <!-- 1) Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <!-- 2) PDF.js UMD build -->
  <script src="https://unpkg.com/pdfjs-dist@2.18.191/build/pdf.min.js"></script>
  <script>
    // Configure the PDF.js worker
    pdfjsLib.GlobalWorkerOptions.workerSrc =
      'https://unpkg.com/pdfjs-dist@2.18.191/build/pdf.worker.min.js';
  </script>

  <!-- 3) Highlight + render logic -->
  <script>
  (function() {
    if (!window.pdfjsLib) {
      console.error('PDF.js not loaded—check the <script> above.');
      return;
    }
    const pdfjs = window.pdfjsLib;

    /** Highlights text matches on the rendered PDF pages. */
    async function getMatches(containerId, matches) {
      if (!Array.isArray(matches) || matches.length === 0) return;
      const pdf = window._loadedPdf;
      const container = document.getElementById(containerId);

      for (let { page, text } of matches) {
        const pageObj = await pdf.getPage(page);
        const viewport = pageObj.getViewport({ scale: 1 });
        const { items } = await pageObj.getTextContent();
        const rects = [];

        for (let item of items) {
          let idx = 0;
          while ((idx = item.str.indexOf(text, idx)) !== -1) {
            const [ , , , , e, f ] = pdfjs.Util.transform(viewport.transform, item.transform);
            const h = item.height * viewport.scale;
            const charW = (item.width * viewport.scale) / item.str.length;
            rects.push({
              x: e + charW * idx,
              y: f - h,
              w: charW * text.length,
              h
            });
            idx += text.length;
          }
        }

        const pageDiv = document.getElementById(`pageContainer${page}`);
        let hlLayer = pageDiv.querySelector('.highlightLayer');
        if (!hlLayer) {
          hlLayer = document.createElement('div');
          Object.assign(hlLayer.style, {
            position: 'absolute',
            top: 0, left: 0,
            width: '100%', height: '100%',
            pointerEvents: 'none'
          });
          hlLayer.className = 'highlightLayer';
          pageDiv.appendChild(hlLayer);
        }

        rects.forEach(r => {
          const hl = document.createElement('div');
          Object.assign(hl.style, {
            position: 'absolute',
            left:   `${r.x}px`,
            top:    `${r.y}px`,
            width:  `${r.w}px`,
            height: `${r.h}px`,
            background: 'rgba(255,255,0,0.4)'
          });
          hlLayer.appendChild(hl);
        });
      }
    }

    // Render PDF pages into #pdfContainer and wire sidebar clicks
    (async () => {
      const url = '../test-data/RIS-lab.pdf';
      const pdf = await pdfjs.getDocument(url).promise;
      window._loadedPdf = pdf;
      const container = document.getElementById('pdfContainer');

      for (let i = 1; i <= pdf.numPages; i++) {
        const page = await pdf.getPage(i);
        const viewport = page.getViewport({ scale: 1 });

        const pageDiv = document.createElement('div');
        pageDiv.id = `pageContainer${i}`;
        pageDiv.className = 'pdf-page';
        Object.assign(pageDiv.style, {
          position: 'relative',
          width:  `${viewport.width}px`,
          height: `${viewport.height}px`
        });

        // Canvas render
        const canvas = document.createElement('canvas');
        canvas.width = viewport.width;
        canvas.height = viewport.height;
        pageDiv.appendChild(canvas);
        await page.render({ canvasContext: canvas.getContext('2d'), viewport }).promise;

        // Text layer
        const textLayerDiv = document.createElement('div');
        textLayerDiv.className = 'textLayer';
        Object.assign(textLayerDiv.style, {
          position: 'absolute',
          top: 0, left: 0,
          width:  `${viewport.width}px`,
          height: `${viewport.height}px`
        });
        pageDiv.appendChild(textLayerDiv);
        container.appendChild(pageDiv);

        page.getTextContent().then(tc => {
          pdfjs.renderTextLayer({
            textContent: tc,
            container: textLayerDiv,
            viewport,
            textDivs: []
          });
        });
      }

      document.getElementById('hitSidebar').addEventListener('click', e => {
        if (e.target.matches('.hit-item')) {
          getMatches('pdfContainer', [JSON.parse(e.target.dataset.match)]);
        }
      });
    })();

    // Chat logic (unchanged)
    (function () {
      const chatContainer = document.getElementById('chatContainer');
      const inputEl = document.getElementById('chatInput');
      const sendBtn = document.getElementById('sendBtn');
      let msgs = JSON.parse(sessionStorage.getItem('ctrlf_chat') || '[]');

      function renderChat() {
        chatContainer.innerHTML = '';
        msgs.forEach(m => {
          const b = document.createElement('div');
          b.className = 'chat-bubble user';
          b.textContent = m;
          chatContainer.appendChild(b);
        });
        chatContainer.scrollTop = chatContainer.scrollHeight;
      }

      function addMessage(text) {
        msgs.push(text);
        sessionStorage.setItem('ctrlf_chat', JSON.stringify(msgs));
        renderChat();
      }

      renderChat();
      sendBtn.addEventListener('click', () => {
        const txt = inputEl.value.trim();
        if (!txt) return;
        addMessage(txt);
        inputEl.value = '';
        inputEl.focus();
      });
      inputEl.addEventListener('keydown', e => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          sendBtn.click();
        }
      });
    })();

    // Expose the function if needed
    window.getMatches = getMatches;
  })();
  </script>
</body>
</html>