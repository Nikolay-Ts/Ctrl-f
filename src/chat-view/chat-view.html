<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ctrl-F Chat Viewer</title>
  <!-- Bootstrap Dark Theme -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
    rel="stylesheet"
  />
  <!-- Custom Styles -->
  <link rel="stylesheet" href="chat-view.css" />
</head>

<body>
  <!-- Navbar -->
  <nav
    class="navbar navbar-expand-lg nav-blur border-bottom border-secondary shadow-sm py-2 sticky-top"
  >
    <div class="container-fluid d-flex justify-content-between align-items-center">
      <div class="d-flex" style="width: 33%;"></div>
      <div class="d-flex justify-content-center" style="width: 33%;">
        <!-- Use button instead of anchor to prevent navigation -->
        <button 
          class="btn btn-link navbar-brand p-0"
          type="button"
          data-bs-toggle="modal"
          data-bs-target="#landingModal"
        >
          <img src="../assets/logo.png" alt="Ctrl-F Logo" height="60" />
        </button>
      </div>
      <div class="d-flex justify-content-end align-items-center" style="width: 33%;">
        <ul class="navbar-nav flex-row">
          <li class="nav-item">
            <a class="nav-link text-light mx-2" href="../about-page/about-page.html"
              >About</a
            >
          </li>
          <li class="nav-item">
            <a
              class="nav-link text-light mx-2"
              href="https://github.com/Nikolay-Ts/Ctrl-f"
              target="_blank"
              >Source</a
            >
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <!-- Main Layout -->
  <div class="container-fluid">
    <div class="row g-0">
      <!-- Chat Column -->
      <div class="col-md-8 bg-dark chat-container" id="chatContainer"></div>
      <!-- PDF Sidebar -->
      <div class="col-md-4 p-3">
        <div class="ultra-card p-3 shadow-lg pdf-container">
          <canvas id="pdf-render"></canvas>
          <div id="highlight-layer"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Landing Page Modal -->
  <div
    class="modal fade"
    id="landingModal"
    tabindex="-1"
    aria-labelledby="landingModalLabel"
    aria-hidden="true"
  >
    <div class="modal-dialog modal-xl modal-dialog-centered" style="max-width: 95vw;">
      <div class="modal-content bg-dark text-light border-0" style="height: 90vh;">
        <div class="modal-header border-bottom border-secondary">
          <h5 class="modal-title" id="landingModalLabel">Upload PDFs & Query</h5>
          <button
            type="button"
            class="btn-close btn-close-white"
            data-bs-dismiss="modal"
            aria-label="Close"
          ></button>
        </div>
        <div class="modal-body p-0" style="overflow: auto;">
          <iframe
            src="../landing-page/landing-page.html"
            style="border: none; width: 100%; height: 100%;"
          ></iframe>
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap & PDF.js -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>

  <!-- Combined Logic -->
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const jsonData = {
        matches: [
          {
            text: 'Found "Ctrl-F" on page 1 at top-right.',
            page: 1,
            coords: [500, 600, 20, 70],
          },
          {
            text: 'Found "PDF Viewer" heading on page 1.',
            page: 1,
            coords: [50, 400, 100, 140],
          },
        ],
      };

      const chatContainer = document.getElementById('chatContainer');
      jsonData.matches.forEach((match, idx) => {
        const bubble = document.createElement('div');
        bubble.className = 'chat-bubble loaded';
        bubble.style.transitionDelay = `${idx * 150}ms`;
        bubble.innerText = match.text;
        bubble.addEventListener('click', () =>
          renderPage(match.page, match.coords)
        );
        chatContainer.appendChild(bubble);
      });

      // PDF.js pointing up into test-data
      const url = '../test-data/RIS-lab.pdf';
      const canvas = document.getElementById('pdf-render');
      const ctx = canvas.getContext('2d');
      const highlightLayer = document.getElementById('highlight-layer');
      let pdfDoc = null;

      pdfjsLib.getDocument(url).promise.then((pdf) => {
        pdfDoc = pdf;
        renderPage(1);
      });

      function clearHighlights() {
        highlightLayer.innerHTML = '';
      }

      function renderPage(pageNum, coords) {
        pdfDoc.getPage(pageNum).then((page) => {
          const viewport = page.getViewport({ scale: 1.5 });
          canvas.width = viewport.width;
          canvas.height = viewport.height;
          canvas.style.width = '100%';
          canvas.style.height = 'auto';
          highlightLayer.style.width = '100%';
          highlightLayer.style.height = '100%';

          page
            .render({ canvasContext: ctx, viewport })
            .promise.then(() => {
              clearHighlights();
              if (coords) {
                const [x1, x2, y1, y2] = coords;
                const [vx1, vy1, vx2, vy2] = viewport.convertToViewportRectangle([
                  x1,
                  y1,
                  x2,
                  y2,
                ]);
                const scaleX = canvas.clientWidth / canvas.width;
                const scaleY = canvas.clientHeight / canvas.height;
                const hl = document.createElement('div');
                hl.className = 'highlight';
                hl.style.left = `${Math.min(vx1, vx2) * scaleX}px`;
                hl.style.top = `${Math.min(vy1, vy2) * scaleY}px`;
                hl.style.width = `${Math.abs(vx2 - vx1) * scaleX}px`;
                hl.style.height = `${Math.abs(vy2 - vy1) * scaleY}px`;
                highlightLayer.appendChild(hl);
              }
            });
        });
      }

      window.addEventListener('resize', () => renderPage(1));
    });
  </script>
</body>
</html>